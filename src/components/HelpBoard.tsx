import { useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { useSidebar } from "../components/SideBar";
import { ProblemChatDialog } from "./ProblemChatDialog";
import { HelpBoardCard } from "./HelpBoardCard";
import { Button } from "./ui/button";
import { Plus } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { db } from "../lib/firebase";
import { collection, getDocs, getDoc, doc } from "firebase/firestore";
import Dropdown from "./Dropdown";

type Problem = {
  id: string;
  title: string;
  description: string;
  category: string;
  course: string;
  urgency: "low" | "medium" | "high";
  image?: string | null;
  createdAt: Date | null;
  user: {
    name: string;
    avatar?: string;
    uid?: string;
  };
  responses: number;
  likes: number;
};

const categories = [
  "All",
  "Mathematics",
  "Science",
  "English",
  "Social Sciences",
  "Foreign Languages",
];

const HelpBoard = () => {
  const [, setProfilePhoto] = useState("");
  const [, setUserName] = useState("User");
  const [problems, setProblems] = useState<Problem[]>([]);
  const [selectedProblem, setSelectedProblem] = useState<Problem | null>(null);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState("All");
  const [, setLoading] = useState(true);

  const { collapsed } = useSidebar();
  const navigate = useNavigate();

  useEffect(() => {
    const fetchUserProfilePicture = async () => {
      try {
        const uid = localStorage.getItem("uid");
        if (!uid) return;

        const userDoc = await getDoc(doc(db, "users", uid));
        if (userDoc.exists()) {
          const data = userDoc.data();
          setProfilePhoto(data.profilePicture || "");
          setUserName(data.username || "User");
        }
      } catch (error) {
        console.error("Failed to fetch profile picture:", error);
      }
    };

    fetchUserProfilePicture();
  }, []);
  useEffect(() => {
    const fetchProblems = async () => {
      try {
        const querySnapshot = await getDocs(collection(db, "problems"));
        const problemsData = querySnapshot.docs.map((doc) => {
          const data = doc.data();
          return {
            id: doc.id,
            title: data.title || "Untitled Problem",
            description: data.description || "No description provided.",
            category: data.category || "General",
            course: data.course || "Unknown Course",
            urgency: data.urgency || "low",
            image: data.image ?? null,
            createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : null,
            user: {
              name: data.user?.name || "Anonymous",
              avatar: data.user?.avatar || "",
              uid: data.user?.uid || "",
            },
            responses: data.responses ?? 0,
            likes: data.likes ?? 0,
          };
        });
        setProblems(problemsData);
      } catch (error) {
        console.error("Error fetching problems:", error);
      } finally {
        setLoading(false);
      }
    };

    fetchProblems();
  }, []);

  const handleHelpClick = (problem: Problem) => {
    setSelectedProblem(problem);
    setIsDialogOpen(true);
  };

  const handleCloseDialog = () => {
    setIsDialogOpen(false);
    setSelectedProblem(null);
  };

  const filteredProblems = problems.filter((problem) =>
    selectedCategory === "All"
      ? true
      : problem.category.toLowerCase() === selectedCategory.toLowerCase()
  );

  const ease = [0.4, 0, 0.2, 1] as const;

  return (
    <div
      className={`bg-[#0A0D17] pt-[30px] min-h-screen pb-16 ${
        collapsed ? "pl-[130px]" : "pl-[280px]"
      } transition-all duration-300`}
    >
      <div className="px-4 max-w-7xl">
        <motion.header
          initial={{ opacity: 0, y: 12 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.4, ease }}
        >
          <h1 className="text-3xl font-bold text-white font-syncopate tracking-tight">
            Academic Center
          </h1>
          <p className="text-muted-foreground mt-1">
            Post your problems and help others solve theirs
          </p>
        </motion.header>

        <div className="absolute top-5 right-[40px] z-50">
          <Dropdown />
        </div>

        <motion.div
          className="mt-6"
          initial={{ opacity: 0, y: 8 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.4, delay: 0.08, ease }}
          whileHover={{ scale: 1.02 }}
          whileTap={{ scale: 0.98 }}
        >
          <Button
            onClick={() => navigate("/post-problem")}
            className="group relative flex items-center gap-2.5 rounded-xl bg-[#7CDCBD] text-[#0A0D17] font-semibold shadow-[0_0_20px_-4px_rgba(124,220,189,0.4)] hover:bg-[#5FBFAA] hover:shadow-[0_0_24px_-2px_rgba(124,220,189,0.5)] transition-all duration-300 ease-out h-11 px-5 border-0"
          >
            <span className="flex items-center justify-center w-6 h-6 rounded-lg bg-[#0A0D17]/10">
              <Plus className="w-4 h-4" strokeWidth={2.5} />
            </span>
            <span>Post a Problem</span>
          </Button>
        </motion.div>

        <motion.nav
          className="flex flex-wrap gap-x-6 gap-y-2 mt-6 text-white text-lg"
          initial={{ opacity: 0, y: 8 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.4, delay: 0.12, ease }}
        >
          {categories.map((cat) => (
            <button
              key={cat}
              onClick={() => setSelectedCategory(cat)}
              className={`px-2 pb-1 transition-all duration-200 border-b-2 ${
                selectedCategory === cat
                  ? "text-white border-white font-semibold"
                  : "text-gray-400 border-transparent hover:text-slate-400 hover:border-white"
              }`}
            >
              {cat}
            </button>
          ))}
        </motion.nav>

        <div className="mt-10 ml-[-30px] mr-[20px] max-w-7xl px-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <AnimatePresence mode="popLayout">
            {filteredProblems.map((problem, index) => (
              <motion.div
                key={problem.id}
                layout
                initial={{ opacity: 0, y: 12 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, scale: 0.98 }}
                transition={{
                  duration: 0.3,
                  delay: index * 0.04,
                  ease,
                }}
              >
                <HelpBoardCard
                  problem={problem}
                  onHelpClick={handleHelpClick}
                />
              </motion.div>
            ))}
          </AnimatePresence>
        </div>
      </div>

      {selectedProblem && (
        <ProblemChatDialog
          isOpen={isDialogOpen}
          onClose={handleCloseDialog}
          problem={selectedProblem}
        />
      )}
    </div>
  );
};

export default HelpBoard;
